<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bitcoin Price Action Visualizer — Navigable</title>
  <style>
    :root {
      --bg: #0f1115;
      --panel: #171a21;
      --text: #e7e9ee;
      --muted: #a6adbb;
      --accent: #6aa9ff;
      --good: #4caf50;
      --bad: #ef5350;
      --grid: #262a33;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg, #0f1115 0%, #0f1115 60%, #0b0d11 100%);
      color: var(--text);
    }
    header {
      padding: 16px 20px;
      border-bottom: 1px solid #1d212b;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    header h1 { margin: 0; font-size: 18px; letter-spacing: .4px; opacity: .95; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 20px; display: grid; gap: 16px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width:900px){ .row{ grid-template-columns: 1fr 340px; } }
    .card { background: var(--panel); border: 1px solid #1d212b; border-radius: 14px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    .legend { display:flex; gap:14px; flex-wrap:wrap; font-size:13px; color:var(--muted); padding-top:6px; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; }
    .status { font-size:12px; color:var(--muted); margin-top:8px; }
    .btnrow { display:flex; flex-wrap:wrap; gap:8px; }
    button { background:#12151c; color:var(--text); border:1px solid #222633; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600; font-size:14px; }
    button:hover { border-color:#2e3344; transform: translateY(-1px); }
    canvas { width:100% !important; height:60vh !important; }
    .controls { display:grid; gap:14px; }
    .group { background:#12151c; border:1px solid #1d212b; border-radius:12px; padding:12px; display:grid; gap:10px; }
    .labelline { display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:13px; }
    input[type="range"] { width:100%; height:4px; border-radius:999px; background:#222633; outline:none; -webkit-appearance:none; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance:none; width:16px; height:16px; border-radius:50%; background:var(--accent); border:2px solid white; cursor:pointer; margin-top:-6px; }
    footer { text-align:center; color:var(--muted); font-size:12px; padding:20px; }
    kbd { background:#0b0d11; border:1px solid #2a2e3a; border-radius:6px; padding:2px 6px; font-size:12px; }
  </style>
</head>
<body>
  <header>
    <h1>Bitcoin Price Action Visualizer</h1>
    <div class="btnrow">
      <button id="btn-reset">Reset Range</button>
      <button id="btn-resetzoom">Reset Zoom</button>
      <button id="btn-scale">Toggle Log Scale</button>
      <button id="btn-save">Save PNG</button>
    </div>
  </header>

  <div class="wrap">
    <div class="row">
      <div class="card">
        <canvas id="chart"></canvas>
        <div class="legend">
          <span><span class="dot" style="background:#6aa9ff"></span>Close</span>
          <span><span class="dot" style="background:#ffb74d"></span>50-Day MA</span>
          <span><span class="dot" style="background:#66bb6a"></span>200-Day MA</span>
          <span><span class="dot" style="background:#ab47bc"></span>RSI 14 (right axis)</span>
        </div>
        <div class="status" id="status">Loading daily data...</div>
      </div>

      <div class="card controls">
        <div class="group">
          <div class="labelline"><div>Start</div><div id="start-date">—</div></div>
          <input id="range-start" type="range" min="0" max="100" value="0" step="1" />
        </div>
        <div class="group">
          <div class="labelline"><div>End</div><div id="end-date">—</div></div>
          <input id="range-end" type="range" min="0" max="100" value="100" step="1" />
        </div>
        <div class="group">
          <div class="labelline"><div>Navigation tips</div></div>
          <div style="font-size:12px; color:#a6adbb">
            Drag to zoom a window. Mouse wheel to zoom. Pinch on trackpad. Hold <kbd>Ctrl</kbd> and drag to pan. 
            Use <kbd>←</kbd>/<kbd>→</kbd> to nudge the window, <kbd>+</kbd>/<kbd>-</kbd> to zoom in/out.
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>Built for GitHub Pages.</footer>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>
  <script>
    // Utilities
    const toYMD = ts => {
      const d = new Date(ts);
      const y = d.getUTCFullYear();
      const m = String(d.getUTCMonth() + 1).padStart(2, "0");
      const d2 = String(d.getUTCDate()).padStart(2, "0");
      return `${y}-${m}-${d2}`;
    };
    const clamp = (x, a, b) => Math.min(Math.max(x, a), b);

    function sma(values, period) {
      const out = Array(values.length).fill(null);
      let sum = 0;
      for (let i = 0; i < values.length; i++) {
        sum += values[i];
        if (i >= period) sum -= values[i - period];
        if (i >= period - 1) out[i] = sum / period;
      }
      return out;
    }
    function rsi(values, period = 14) {
      const out = Array(values.length).fill(null);
      let gain = 0, loss = 0;
      for (let i = 1; i < values.length; i++) {
        const delta = values[i] - values[i - 1];
        const up = Math.max(delta, 0);
        const dn = Math.max(-delta, 0);
        if (i <= period) {
          gain += up; loss += dn;
          if (i === period) {
            const rs = loss === 0 ? 100 : gain / loss;
            out[i] = 100 - 100 / (1 + rs);
          }
        } else {
          gain = (gain * (period - 1) + up) / period;
          loss = (loss * (period - 1) + dn) / period;
          const rs = loss === 0 ? 100 : gain / loss;
          out[i] = 100 - 100 / (1 + rs);
        }
      }
      return out;
    }

    // State
    let raw = null;
    let state = { idxStart: 0, idxEnd: 0, logScale: false };

    // Elements
    const elStart = document.getElementById("range-start");
    const elEnd = document.getElementById("range-end");
    const elStartDate = document.getElementById("start-date");
    const elEndDate = document.getElementById("end-date");
    const elStatus = document.getElementById("status");

    // Chart
    const ctx = document.getElementById("chart");
    const chart = new Chart(ctx, {
      type: "line",
      data: { labels: [], datasets: [
        { label: "Close", data: [], borderWidth: 1.5, pointRadius: 0, tension: 0.08, borderColor: "#6aa9ff" },
        { label: "50-Day MA", data: [], borderDash: [6,6], borderWidth: 1.5, pointRadius: 0, tension: 0.08, borderColor: "#ffb74d" },
        { label: "200-Day MA", data: [], borderDash: [6,6], borderWidth: 1.5, pointRadius: 0, tension: 0.08, borderColor: "#66bb6a" },
        { label: "RSI 14", data: [], borderWidth: 1, pointRadius: 0, yAxisID: "rsi", tension: 0, borderColor: "#ab47bc" }
      ]},
      options: {
        animation: false,
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { grid: { color: getComputedStyle(document.documentElement).getPropertyValue("--grid") }, ticks: { maxTicksLimit: 12, color: "#c8cfdd" } },
          y: { type: "linear", position: "left", grid: { color: getComputedStyle(document.documentElement).getPropertyValue("--grid") }, ticks: { color: "#c8cfdd" } },
          rsi: { type: "linear", position: "right", min: 0, max: 100, grid: { color: "rgba(171,71,188,0.15)" }, ticks: { color: "#d3b5df", maxTicksLimit: 5 } }
        },
        plugins: {
          legend: { display: false },
          tooltip: { mode: "index", intersect: false },
          zoom: {
            limits: { x: { minRange: 10 } },
            pan: { enabled: true, modifierKey: "ctrl", mode: "x" },
            zoom: {
              wheel: { enabled: true },
              drag: { enabled: true, backgroundColor: "rgba(106,169,255,0.15)", borderWidth: 1, borderColor: "rgba(106,169,255,0.5)" },
              pinch: { enabled: true },
              mode: "x"
            }
          }
        }
      }
    });

    function updateRangeLabels() {
      if (!raw) return;
      elStartDate.textContent = raw.labels[state.idxStart];
      elEndDate.textContent = raw.labels[state.idxEnd];
    }

    function applyRange() {
      if (!raw) return;
      const { labels, close, ma50, ma200, rsi14 } = raw;
      const s = state.idxStart, e = state.idxEnd;
      chart.data.labels = labels.slice(s, e + 1);
      chart.data.datasets[0].data = close.slice(s, e + 1);
      chart.data.datasets[1].data = ma50.slice(s, e + 1);
      chart.data.datasets[2].data = ma200.slice(s, e + 1);
      chart.data.datasets[3].data = rsi14.slice(s, e + 1);
      chart.options.scales.y.type = state.logScale ? "logarithmic" : "linear";
      chart.update();
      updateRangeLabels();
    }

    function setRange(s, e) {
      s = clamp(s, 0, raw.labels.length - 2);
      e = clamp(e, s + 1, raw.labels.length - 1);
      state.idxStart = s;
      state.idxEnd = e;
      elStart.value = s;
      elEnd.value = e;
      applyRange();
    }

    function currentWindow() { return state.idxEnd - state.idxStart + 1; }

    // Slider events
    function clampSliders() {
      let s = parseInt(elStart.value, 10);
      let e = parseInt(elEnd.value, 10);
      if (s >= e) {
        if (s === state.idxStart) s = e - 1;
        else e = s + 1;
      }
      setRange(s, e);
    }
    elStart.addEventListener("input", clampSliders);
    elEnd.addEventListener("input", clampSliders);

    // Keyboard navigation
    window.addEventListener("keydown", (ev) => {
      if (!raw) return;
      const width = currentWindow();
      const step = Math.max(1, Math.floor(width * 0.05)); // 5% nudge
      if (ev.key === "ArrowRight") {
        setRange(state.idxStart + step, state.idxEnd + step);
      } else if (ev.key === "ArrowLeft") {
        setRange(state.idxStart - step, state.idxEnd - step);
      } else if (ev.key === "+" || ev.key === "=") { // zoom in
        const shrink = Math.max(2, Math.floor(width * 0.1));
        setRange(state.idxStart + shrink, state.idxEnd - shrink);
      } else if (ev.key === "-" || ev.key === "_") { // zoom out
        const grow = Math.max(2, Math.floor(width * 0.1));
        setRange(state.idxStart - grow, state.idxEnd + grow);
      }
    });

    // Buttons
    document.getElementById("btn-reset").addEventListener("click", () => {
      if (!raw) return;
      setRange(0, raw.labels.length - 1);
    });
    document.getElementById("btn-resetzoom").addEventListener("click", () => {
      chart.resetZoom();
    });
    document.getElementById("btn-scale").addEventListener("click", () => {
      state.logScale = !state.logScale;
      applyRange();
      elStatus.textContent = state.logScale ? "Log scale enabled" : "Linear scale enabled";
    });
    document.getElementById("btn-save").addEventListener("click", () => {
      const a = document.createElement("a");
      a.href = chart.toBase64Image("image/png", 1.0);
      a.download = "bitcoin_price_chart.png";
      a.click();
    });

    // Data loading with fallback
    async function fetchWithTimeout(url, opts = {}, timeoutMs = 15000) {
      const ctrl = new AbortController(); const t = setTimeout(() => ctrl.abort(), timeoutMs);
      try { return await fetch(url, { ...opts, signal: ctrl.signal }); }
      finally { clearTimeout(t); }
    }
    async function loadFromCG() {
      const url = "https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=max";
      const res = await fetchWithTimeout(url, { headers: {"accept":"application/json"} });
      if (!res.ok) throw new Error("CoinGecko HTTP " + res.status);
      const j = await res.json();
      return j.prices.map(p => [p[0], Number(p[1])]);
    }
    async function loadFromCC() {
      const url = "https://min-api.cryptocompare.com/data/v2/histoday?fsym=BTC&tsym=USD&allData=true";
      const res = await fetchWithTimeout(url, { headers: {"accept":"application/json"} });
      if (!res.ok) throw new Error("CryptoCompare HTTP " + res.status);
      const j = await res.json();
      if (j.Response !== "Success") throw new Error("CryptoCompare: " + (j.Message || "Unknown"));
      return j.Data.Data.map(p => [p.time*1000, Number(p.close)]);
    }

    async function load() {
      try {
        elStatus.textContent = "Fetching BTC daily candles (CoinGecko)...";
        let rows;
        try { rows = await loadFromCG(); }
        catch (e) { console.warn(e); elStatus.textContent = "CoinGecko failed, trying fallback..."; rows = await loadFromCC(); }
        const labels = rows.map(r => toYMD(r[0]));
        const close = rows.map(r => r[1]);
        raw = {
          labels,
          close,
          ma50: sma(close, 50),
          ma200: sma(close, 200),
          rsi14: rsi(close, 14)
        };
        // init sliders
        elStart.min = 0; elStart.max = labels.length - 1; elStart.value = 0;
        elEnd.min = 0; elEnd.max = labels.length - 1; elEnd.value = labels.length - 1;
        state.idxStart = 0; state.idxEnd = labels.length - 1;
        applyRange();
        elStatus.textContent = `Loaded ${labels.length} daily candles. Drag to zoom, Ctrl+drag to pan.`;
      } catch (err) {
        console.error(err);
        elStatus.textContent = "Error loading data: " + err.message;
      }
    }

    load();
  </script>
</body>
</html>
